---
name: Database Schema Extensions
status: completed
created: 2025-09-27T06:20:58Z
updated: 2025-09-27T19:12:29Z
github: https://github.com/Montinou/stratixV2/issues/62
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Database Schema Extensions

## Description
Extend the existing PostgreSQL schema to support AI interactions and caching. Create minimal tables for tracking AI usage, costs, and implementing intelligent caching to reduce API costs. Design schema to integrate seamlessly with existing user and organization structures.

## Acceptance Criteria
- [x] Create `ai_interactions` table for tracking all AI requests and responses
- [x] Create `ai_cache` table for intelligent response caching
- [x] Add proper indexes for performance optimization (B-tree and GIN where appropriate)
- [x] Implement foreign key relationships to existing `users` and `organizations` tables
- [x] Create migration scripts following existing NeonDB pattern
- [x] Add cost tracking fields for budget management
- [x] Implement cache expiration and cleanup mechanisms
- [x] Set up proper permissions and security policies

## Technical Details
- Implementation approach: Extend existing NeonDB schema with minimal additions
- Key considerations:
  - Performance optimization with strategic indexing
  - Data retention policies for cost management
  - Integration with existing auth and org structure
- Code locations/files affected:
  - New migration files following existing pattern
  - Database schema documentation updates
  - Integration with existing migration scripts

## Database Schema
```sql
-- AI interactions tracking
CREATE TABLE ai_interactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL, -- 'template', 'chat', 'insights'
    request_data JSONB NOT NULL,
    response_data JSONB,
    cost_cents INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'completed', 'failed'
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    INDEX idx_ai_interactions_user_id (user_id),
    INDEX idx_ai_interactions_org_id (organization_id),
    INDEX idx_ai_interactions_type (type),
    INDEX idx_ai_interactions_created (created_at)
);

-- AI response caching
CREATE TABLE ai_cache (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    cache_key VARCHAR(255) UNIQUE NOT NULL,
    response_data JSONB NOT NULL,
    cost_cents INTEGER DEFAULT 0,
    hit_count INTEGER DEFAULT 0,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    last_accessed TIMESTAMP DEFAULT NOW(),
    INDEX idx_ai_cache_key (cache_key),
    INDEX idx_ai_cache_expires (expires_at)
);
```

## Dependencies
- [ ] Access to NeonDB database instance
- [ ] Existing migration script infrastructure
- [ ] Understanding of current user and organization schema
- [ ] Database backup and rollback procedures

## Effort Estimate
- Size: S
- Hours: 1-2 days (8-16 hours)
- Parallel: true (independent of AI client setup)

## Definition of Done
- [x] Database schema successfully deployed to development environment
- [x] Migration scripts tested and can be rolled back safely
- [x] Foreign key relationships properly established and tested
- [x] Indexes created and performance validated with sample data
- [x] Cache cleanup procedures implemented and scheduled
- [x] Schema changes documented in project documentation
- [x] Security policies tested with different user roles