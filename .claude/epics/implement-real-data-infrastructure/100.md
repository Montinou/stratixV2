---
name: Create RLS Client Infrastructure
status: open
created: 2025-10-01T02:51:14Z
updated: 2025-10-01T03:09:41Z
github: https://github.com/Montinou/stratixV2/issues/100
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Create RLS Client Infrastructure

## Description

Create the foundational database client infrastructure that sets PostgreSQL Row Level Security (RLS) context before every tenant-scoped query. This is the critical foundation that enables all other tasks by ensuring multi-tenant data isolation at the database level.

## Acceptance Criteria

- [ ] File `lib/database/rls-client.ts` created
- [ ] Function `setUserContext(userId: string)` executes `SELECT set_config('app.current_user_id', $1, true)`
- [ ] Function `withRLSContext(userId, callback)` wraps queries with context setting
- [ ] Function `getDb()` returns Drizzle instance connected to `DATABASE_URL_UNPOOLED`
- [ ] Type-safe with Drizzle schema inference
- [ ] All functions properly typed (no `any` types)
- [ ] Documentation added with JSDoc comments
- [ ] Test query runs successfully with RLS context

## Technical Details

**Implementation Approach**:
```typescript
import { Pool } from 'pg';
import { drizzle } from 'drizzle-orm/node-postgres';
import * as schema from '@/db/okr-schema';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL_UNPOOLED,
});

export async function setUserContext(userId: string) {
  if (!userId) {
    throw new Error('User ID is required for RLS context');
  }
  await pool.query('SELECT set_config($1, $2, true)', ['app.current_user_id', userId]);
}

export function getDb() {
  return drizzle(pool, { schema });
}

export async function withRLSContext<T>(
  userId: string,
  callback: () => Promise<T>
): Promise<T> {
  await setUserContext(userId);
  return await callback();
}
```

**Files to Create**:
- `lib/database/rls-client.ts`

**Key Considerations**:
- Use `DATABASE_URL_UNPOOLED` for proper RLS context setting
- Throw errors immediately if userId is null/undefined
- Each request gets its own context (transaction-scoped)
- Export typed `getDb()` for service layer usage

## Dependencies

**External**:
- [ ] NeonDB database available
- [ ] Environment variable `DATABASE_URL_UNPOOLED` configured

**Internal**:
- [ ] Drizzle schema exists (`db/okr-schema.ts`) - ✅ Already exists
- [ ] RLS policies applied to database - ✅ Already applied

## Effort Estimate

- **Size**: S
- **Hours**: 2 hours
- **Parallel**: false (foundation task - blocks all other tasks)

## Definition of Done

- [ ] Code implemented and follows TypeScript strict mode
- [ ] All functions have JSDoc documentation
- [ ] Manual test: Run simple query with RLS context set
- [ ] Verified: Context setting executes without errors
- [ ] Code reviewed for security (no SQL injection, proper error handling)
- [ ] Committed to version control
