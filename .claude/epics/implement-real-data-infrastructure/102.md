---
name: Implement Analytics Page Real Data
status: open
created: 2025-10-01T02:51:14Z
updated: 2025-10-01T03:09:41Z
github: https://github.com/Montinou/stratixV2/issues/102
depends_on: [001, 002, 003, 004, 005]
parallel: false
conflicts_with: []
---

# Task: Implement Analytics Page Real Data

## Description
Replace mock data in the Analytics page with real complex database queries using Neon PostgreSQL. Implement comprehensive analytics service with GROUP BY queries for department progress, top performers, upcoming deadlines, and completion trends. This is the most complex data implementation requiring advanced SQL queries.

## Acceptance Criteria
- [ ] Service file completed: `lib/services/analytics-service.ts`
- [ ] Page updated: `/app/tools/analytics/page.tsx`
- [ ] Mock data arrays removed completely
- [ ] Empty state tested (displays when no data)
- [ ] Multi-tenant isolation verified (User A cannot see User B's data)
- [ ] All analytics widgets show real data
- [ ] Charts and visualizations display correctly with proper formatting
- [ ] Performance <2s with complex GROUP BY queries
- [ ] TypeScript build passes with no errors

## Technical Details

### Service Implementation
Complete `lib/services/analytics-service.ts` with 4 key functions:

```typescript
export async function getDepartmentProgress(organizationId: string) {
  // GROUP BY department from profiles
  // Calculate completion rates per department
  // Join with objectives/initiatives to get progress
  // Return: department_name, total_objectives, completed, completion_rate
  // Order by completion_rate DESC
}

export async function getTopPerformers(organizationId: string, limit: number = 5) {
  // GROUP BY user_id from activities/initiatives
  // COUNT completed items per user
  // JOIN profiles for user details
  // Return: user_name, completed_count, active_count
  // Order by completed_count DESC LIMIT 5
}

export async function getUpcomingDeadlines(organizationId: string, days: number = 7) {
  // Query activities and initiatives
  // WHERE due_date BETWEEN CURRENT_DATE AND CURRENT_DATE + interval '7 days'
  // AND status != 'completed'
  // Return: title, type, due_date, assignee, priority
  // Order by due_date ASC
}

export async function getCompletionTrends(organizationId: string, months: number = 6) {
  // GROUP BY date_trunc('month', completion_date)
  // COUNT objectives, initiatives, activities completed per month
  // WHERE completion_date >= CURRENT_DATE - interval '6 months'
  // Return: month, objectives_completed, initiatives_completed, activities_completed
  // Order by month ASC
}
```

### Database Tables & Queries
- **Department Progress**:
  - JOIN: `profiles` -> `objectives` ON owner_id
  - GROUP BY: `profiles.department`
  - Aggregate: COUNT(*), SUM(CASE WHEN status = 'completed')

- **Top Performers**:
  - JOIN: `activities` -> `profiles` ON assignee_id
  - GROUP BY: `profiles.user_id, profiles.full_name`
  - Aggregate: COUNT(CASE WHEN status = 'completed')

- **Upcoming Deadlines**:
  - UNION query: activities + initiatives
  - Filter: due_date range, status != 'completed'
  - Sort: due_date ASC

- **Completion Trends**:
  - Multiple queries with date_trunc('month', completion_date)
  - GROUP BY: month
  - Aggregate: COUNT(*) per entity type

### Complex Query Examples
```sql
-- Department Progress
SELECT
  p.department,
  COUNT(o.id) as total_objectives,
  COUNT(CASE WHEN o.status = 'completed' THEN 1 END) as completed,
  ROUND(COUNT(CASE WHEN o.status = 'completed' THEN 1 END)::numeric /
        COUNT(o.id)::numeric * 100, 2) as completion_rate
FROM profiles p
LEFT JOIN objectives o ON p.user_id = o.owner_id
WHERE p.organization_id = $1
GROUP BY p.department
ORDER BY completion_rate DESC;

-- Top Performers
SELECT
  p.full_name,
  COUNT(CASE WHEN a.status = 'completed' THEN 1 END) as completed_count,
  COUNT(CASE WHEN a.status IN ('pending', 'in_progress') THEN 1 END) as active_count
FROM profiles p
LEFT JOIN activities a ON p.user_id = a.assignee_id
WHERE p.organization_id = $1
GROUP BY p.user_id, p.full_name
ORDER BY completed_count DESC
LIMIT $2;
```

### Page Integration
Update `/app/tools/analytics/page.tsx`:
- Replace all mock analytics data with service calls
- Update department progress chart
- Update top performers list
- Update upcoming deadlines table
- Update completion trends chart
- Handle empty states for each widget
- Maintain existing UI/UX design

## Dependencies
- [ ] Task 001 completed (RLS infrastructure)
- [ ] Task 002 completed (RLS verification)
- [ ] Task 003 completed (Objectives page real data)
- [ ] Task 004 completed (Initiatives page real data)
- [ ] Task 005 completed (Activities page real data)

## Effort Estimate
- **Size**: M
- **Hours**: 4 hours
- **Parallel**: false (must wait for other pages)

## Definition of Done
- [ ] Code implemented
- [ ] Multi-tenant tested with 2 organizations
- [ ] Empty states tested for all widgets
- [ ] Complex GROUP BY queries verified
- [ ] Performance benchmark met (<2s)
- [ ] Charts render correctly with real data
- [ ] Code reviewed
- [ ] TypeScript build passes with no errors
