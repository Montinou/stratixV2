# Gesti√≥n de Estado de Onboarding

## Problema

Usuario en medio del onboarding:
1. Est√° en `/onboarding/create`
2. Cierra el navegador / Recarga p√°gina / Pierde conexi√≥n
3. Vuelve a hacer login
4. **¬øQu√© pasa?** ‚Üí Debe volver al onboarding, no a otra parte

---

## ‚úÖ Soluci√≥n: Tabla de Tracking

### Tabla: `onboarding_sessions`

```sql
CREATE TABLE onboarding_sessions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id text NOT NULL UNIQUE,  -- Stack Auth user ID
  email text NOT NULL,

  -- Estado del onboarding
  status text NOT NULL,  -- 'in_progress', 'completed', 'abandoned'
  current_step text NOT NULL,  -- 'create_org', 'accept_invite', 'complete_profile'

  -- Datos parciales (JSON para flexibilidad)
  partial_data jsonb DEFAULT '{}',

  -- Metadata
  invitation_token text,  -- Si lleg√≥ por invitaci√≥n
  started_at timestamp DEFAULT now(),
  completed_at timestamp,
  last_activity timestamp DEFAULT now(),

  -- Auditor√≠a
  created_at timestamp DEFAULT now(),
  updated_at timestamp DEFAULT now()
);

CREATE INDEX idx_onboarding_user ON onboarding_sessions(user_id);
CREATE INDEX idx_onboarding_status ON onboarding_sessions(status);
CREATE INDEX idx_onboarding_token ON onboarding_sessions(invitation_token);
```

### Estados Posibles:

| Status | Descripci√≥n |
|--------|-------------|
| `in_progress` | Usuario en medio del onboarding |
| `completed` | Onboarding terminado (tiene profile) |
| `abandoned` | >7 d√≠as sin actividad |

### Steps Posibles:

| Step | Descripci√≥n |
|------|-------------|
| `create_org` | Creando organizaci√≥n nueva |
| `accept_invite` | Aceptando invitaci√≥n |
| `complete_profile` | Completando datos adicionales |

---

## üîÑ Flujo Completo con Persistencia

### Escenario 1: Crear Nueva Organizaci√≥n

```
1. Usuario hace Sign Up
   ‚Üì
2. ensureAuthenticated()
   - No tiene profile
   - No tiene invitaci√≥n
   ‚Üì
3. Crear sesi√≥n de onboarding
   INSERT INTO onboarding_sessions (
     user_id: "user_123",
     email: "user@example.com",
     status: "in_progress",
     current_step: "create_org"
   )
   ‚Üì
4. Redirect ‚Üí /onboarding/create
   ‚Üì
5. Usuario llena formulario:
   - Nombre: "Mi Empresa"
   - Industria: "Tecnolog√≠a"
   ‚Üì
   [Usuario cierra navegador aqu√≠] üî¥
   ‚Üì
6. Usuario vuelve, hace login
   ‚Üì
7. ensureAuthenticated()
   - No tiene profile
   - Busca onboarding_sessions WHERE user_id = "user_123"
   - Encuentra: status = "in_progress", step = "create_org"
   ‚Üì
8. Redirect ‚Üí /onboarding/create
   ‚Üì
9. P√°gina carga partial_data (si hay)
   - Pre-llena campos si guard√≥ borrador
   ‚Üì
10. Usuario completa y env√≠a
    ‚Üì
11. Sistema crea org + profile
    ‚Üì
12. Actualizar sesi√≥n:
    UPDATE onboarding_sessions
    SET status = "completed",
        completed_at = now()
    WHERE user_id = "user_123"
    ‚Üì
13. Redirect ‚Üí /tools ‚úì
```

### Escenario 2: Aceptar Invitaci√≥n

```
1. Usuario recibe email, click en link
   ‚Üì
2. /invite/abc123 (sin estar logueado)
   ‚Üì
3. Stack Auth: Sign Up / Sign In
   ‚Üì
4. Despu√©s de auth, redirect a /invite/abc123
   ‚Üì
5. Crear sesi√≥n de onboarding
   INSERT INTO onboarding_sessions (
     user_id: "user_456",
     email: "invited@example.com",
     status: "in_progress",
     current_step: "accept_invite",
     invitation_token: "abc123"
   )
   ‚Üì
6. Mostrar info de invitaci√≥n
   ‚Üì
   [Usuario cierra navegador] üî¥
   ‚Üì
7. Usuario vuelve, hace login
   ‚Üì
8. ensureAuthenticated()
   - No tiene profile
   - Busca onboarding_sessions
   - Encuentra: status = "in_progress", step = "accept_invite", token = "abc123"
   ‚Üì
9. Redirect ‚Üí /invite/abc123
   ‚Üì
10. Usuario acepta
    ‚Üì
11. Sistema crea profile en tenant de la invitaci√≥n
    ‚Üì
12. Marcar onboarding completo
    ‚Üì
13. Redirect ‚Üí /tools ‚úì
```

---

## üíæ Auto-Save de Borradores

Para mejor UX, guardamos borradores autom√°ticamente:

```typescript
// En /onboarding/create
useEffect(() => {
  const autoSave = setTimeout(() => {
    // Guardar cada 30 segundos
    fetch('/api/onboarding/draft', {
      method: 'PUT',
      body: JSON.stringify({
        organizationName: form.organizationName,
        industry: form.industry,
      }),
    });
  }, 30000);

  return () => clearTimeout(autoSave);
}, [form]);
```

Backend guarda en `partial_data`:
```typescript
await db.update(onboardingSessions)
  .set({
    partialData: data,
    lastActivity: new Date(),
  })
  .where(eq(onboardingSessions.userId, userId));
```

---

## üéØ Actualizaci√≥n de ensureAuthenticated()

```typescript
export async function ensureAuthenticated() {
  const user = await stackServerApp.getUser({ or: 'redirect' });

  // Verificar email verificado
  const isVerified = await user.primaryEmailVerified;
  if (!isVerified) {
    redirect(stackServerApp.urls.emailVerification);
  }

  // 1. Verificar si usuario tiene perfil (onboarding completo)
  const profile = await db.query.profiles.findFirst({
    where: eq(profiles.id, user.id),
    with: { company: true },
  });

  if (profile) {
    // ‚úÖ Usuario completo ‚Üí acceso normal
    return { user, profile };
  }

  // 2. Usuario SIN perfil ‚Üí verificar sesi√≥n de onboarding
  let onboardingSession = await db.query.onboardingSessions.findFirst({
    where: eq(onboardingSessions.userId, user.id),
  });

  // 3. Si no hay sesi√≥n, crear una nueva
  if (!onboardingSession) {
    // Verificar si tiene invitaci√≥n pendiente
    const pendingInvitation = await db.query.organizationInvitations.findFirst({
      where: and(
        eq(organizationInvitations.email, user.primaryEmail),
        eq(organizationInvitations.status, 'pending'),
        gte(organizationInvitations.expiresAt, new Date())
      ),
    });

    if (pendingInvitation) {
      // Crear sesi√≥n para aceptar invitaci√≥n
      [onboardingSession] = await db.insert(onboardingSessions).values({
        userId: user.id,
        email: user.primaryEmail,
        status: 'in_progress',
        currentStep: 'accept_invite',
        invitationToken: pendingInvitation.token,
      }).returning();

      redirect(`/invite/${pendingInvitation.token}`);
    } else {
      // Crear sesi√≥n para crear organizaci√≥n
      [onboardingSession] = await db.insert(onboardingSessions).values({
        userId: user.id,
        email: user.primaryEmail,
        status: 'in_progress',
        currentStep: 'create_org',
      }).returning();

      redirect('/onboarding/create');
    }
  }

  // 4. Ya hay sesi√≥n ‚Üí continuar donde lo dej√≥
  switch (onboardingSession.status) {
    case 'in_progress':
      // Actualizar last_activity
      await db.update(onboardingSessions)
        .set({ lastActivity: new Date() })
        .where(eq(onboardingSessions.id, onboardingSession.id));

      // Redirigir seg√∫n el step
      if (onboardingSession.currentStep === 'accept_invite' && onboardingSession.invitationToken) {
        redirect(`/invite/${onboardingSession.invitationToken}`);
      } else if (onboardingSession.currentStep === 'create_org') {
        redirect('/onboarding/create');
      } else {
        redirect('/onboarding/complete');
      }
      break;

    case 'completed':
      // Extra√±o: tiene sesi√≥n completa pero no tiene profile
      // Limpiar y empezar de nuevo
      await db.delete(onboardingSessions)
        .where(eq(onboardingSessions.id, onboardingSession.id));
      redirect('/onboarding/create');
      break;

    case 'abandoned':
      // Reactivar sesi√≥n
      await db.update(onboardingSessions)
        .set({
          status: 'in_progress',
          lastActivity: new Date(),
        })
        .where(eq(onboardingSessions.id, onboardingSession.id));

      if (onboardingSession.currentStep === 'accept_invite' && onboardingSession.invitationToken) {
        redirect(`/invite/${onboardingSession.invitationToken}`);
      } else {
        redirect('/onboarding/create');
      }
      break;
  }

  // No deber√≠a llegar aqu√≠
  redirect('/onboarding/create');
}
```

---

## üìù API Endpoints para Onboarding

### PUT /api/onboarding/draft
Guardar borrador del formulario

```typescript
export async function PUT(request: Request) {
  const user = await stackServerApp.getUser({ or: 'throw' });
  const data = await request.json();

  await db.update(onboardingSessions)
    .set({
      partialData: data,
      lastActivity: new Date(),
    })
    .where(eq(onboardingSessions.userId, user.id));

  return Response.json({ success: true });
}
```

### GET /api/onboarding/status
Obtener estado actual del onboarding

```typescript
export async function GET(request: Request) {
  const user = await stackServerApp.getUser({ or: 'throw' });

  const session = await db.query.onboardingSessions.findFirst({
    where: eq(onboardingSessions.userId, user.id),
  });

  return Response.json(session);
}
```

### POST /api/onboarding/complete
Marcar onboarding como completo

```typescript
export async function POST(request: Request) {
  const user = await stackServerApp.getUser({ or: 'throw' });

  await db.update(onboardingSessions)
    .set({
      status: 'completed',
      completedAt: new Date(),
    })
    .where(eq(onboardingSessions.userId, user.id));

  return Response.json({ success: true });
}
```

---

## üßπ Limpieza Autom√°tica

### Funci√≥n para marcar sesiones abandonadas

```typescript
// Ejecutar diariamente (cron job o Vercel cron)
export async function cleanupAbandonedSessions() {
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

  await db.update(onboardingSessions)
    .set({ status: 'abandoned' })
    .where(
      and(
        eq(onboardingSessions.status, 'in_progress'),
        lt(onboardingSessions.lastActivity, sevenDaysAgo)
      )
    );
}
```

---

## üé® UI de Onboarding con Draft Loading

### /onboarding/create con Draft

```tsx
'use client';

import { useEffect, useState } from 'react';
import { useUser } from '@stackframe/stack';

export default function CreateOrganizationPage() {
  const user = useUser({ or: 'redirect' });
  const [loading, setLoading] = useState(true);
  const [form, setForm] = useState({
    organizationName: '',
    industry: '',
  });

  // Cargar borrador al montar
  useEffect(() => {
    async function loadDraft() {
      try {
        const response = await fetch('/api/onboarding/status');
        const session = await response.json();

        if (session?.partialData) {
          setForm({
            organizationName: session.partialData.organizationName || '',
            industry: session.partialData.industry || '',
          });
        }
      } catch (error) {
        console.error('Error loading draft:', error);
      } finally {
        setLoading(false);
      }
    }

    loadDraft();
  }, []);

  // Auto-save cada 30 segundos
  useEffect(() => {
    if (!loading && (form.organizationName || form.industry)) {
      const timer = setTimeout(() => {
        fetch('/api/onboarding/draft', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(form),
        });
      }, 30000);

      return () => clearTimeout(timer);
    }
  }, [form, loading]);

  if (loading) {
    return <div>Cargando...</div>;
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Crea tu Organizaci√≥n</CardTitle>
        {form.organizationName && (
          <CardDescription className="text-green-600">
            üìù Borrador guardado autom√°ticamente
          </CardDescription>
        )}
      </CardHeader>
      {/* ... resto del formulario */}
    </Card>
  );
}
```

---

## üìä Diagrama de Estados

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Sign Up   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ensureAuthenticated ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
   Has Profile?
       ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê
  YES     NO
   ‚îÇ       ‚îÇ
   ‚îÇ       ‚ñº
   ‚îÇ   Has Onboarding Session?
   ‚îÇ       ‚îÇ
   ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  YES     NO
   ‚îÇ   ‚îÇ       ‚îÇ
   ‚îÇ   ‚îÇ       ‚ñº
   ‚îÇ   ‚îÇ   Create New Session
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Has Invite? ‚Üí accept_invite
   ‚îÇ   ‚îÇ   ‚îî‚îÄ No Invite?  ‚Üí create_org
   ‚îÇ   ‚îÇ
   ‚îÇ   ‚ñº
   ‚îÇ   Session Status?
   ‚îÇ   ‚îú‚îÄ in_progress ‚Üí Continue
   ‚îÇ   ‚îú‚îÄ completed   ‚Üí Cleanup & restart
   ‚îÇ   ‚îî‚îÄ abandoned   ‚Üí Reactivate
   ‚îÇ
   ‚ñº
/tools ‚úì
```

---

## ‚úÖ Checklist de Implementaci√≥n

### Base de Datos
- [ ] Crear tabla `onboarding_sessions`
- [ ] Crear √≠ndices necesarios

### Backend
- [ ] Actualizar `ensureAuthenticated()` con l√≥gica de sesiones
- [ ] API: `PUT /api/onboarding/draft`
- [ ] API: `GET /api/onboarding/status`
- [ ] API: `POST /api/onboarding/complete`
- [ ] Funci√≥n: `cleanupAbandonedSessions()`

### Frontend
- [ ] Actualizar `/onboarding/create` con draft loading
- [ ] Actualizar `/invite/[token]` con sesi√≥n tracking
- [ ] Agregar auto-save en formularios
- [ ] Indicador visual de "borrador guardado"

### Testing
- [ ] Usuario cierra en medio ‚Üí vuelve al mismo paso
- [ ] Borrador se guarda y se carga correctamente
- [ ] Sesiones abandonadas se marcan despu√©s de 7 d√≠as
- [ ] Usuario puede completar despu√©s de interrupci√≥n

---

## üéØ Ventajas de esta Soluci√≥n

‚úÖ **Persistencia Robusta**: Estado guardado en DB, no en localStorage
‚úÖ **Auto-Save**: Borrador guardado autom√°ticamente
‚úÖ **Recuperaci√≥n**: Usuario puede continuar donde lo dej√≥
‚úÖ **Auditor√≠a**: Sabemos cu√°ntos completan vs. abandonan
‚úÖ **Limpieza**: Sesiones viejas se marcan como abandonadas
‚úÖ **Flexible**: `partial_data` en JSON permite evoluci√≥n

---

## üìà M√©tricas de Onboarding

Con esta tabla podemos medir:

```sql
-- Tasa de completaci√≥n
SELECT
  COUNT(CASE WHEN status = 'completed' THEN 1 END)::float / COUNT(*) * 100 as completion_rate
FROM onboarding_sessions;

-- Tiempo promedio para completar
SELECT
  AVG(EXTRACT(EPOCH FROM (completed_at - started_at)) / 60) as avg_minutes
FROM onboarding_sessions
WHERE status = 'completed';

-- Abandono por step
SELECT
  current_step,
  COUNT(*) as abandoned_count
FROM onboarding_sessions
WHERE status = 'abandoned'
GROUP BY current_step;
```

---

¬øProcedo con implementar este sistema de persistencia de onboarding?
